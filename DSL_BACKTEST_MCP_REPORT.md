# DSL / Backtest / MCP Technical Report

Generated from source code structure in current workspace.

## DSL Engine

- `src/engine/strategy/__init__.py`: Strategy DSL validation/parsing engine.
- `src/engine/strategy/errors.py`: Error models for strategy DSL validation/parsing.
  - `class StrategyDslError:`
  - `class StrategyDslValidationResult:`
  - `class StrategyDslValidationError(ValueError):`
  - `def __init__(self, errors: list[StrategyDslError]) -> None:`
- `src/engine/strategy/models.py`: Typed model objects for validated strategy DSL payloads.
  - `class FactorDefinition:`
  - `class StrategyInfo:`
  - `class StrategyUniverse:`
  - `class ParsedStrategyDsl:`
- `src/engine/strategy/schema.py`: JSON schema validation for strategy DSL payloads.
  - `def load_dsl_schema() -> dict[str, Any]:`
  - `def _validator() -> Draft202012Validator:`
  - `def _format_path(error: ValidationError) -> str:`
  - `def _map_schema_error(error: ValidationError) -> StrategyDslError:`
  - `def validate_against_schema(payload: dict[str, Any]) -> list[StrategyDslError]:`
- `src/engine/strategy/semantic.py`: Semantic validation for strategy DSL payloads.
  - `def _is_number(value: Any) -> bool:`
  - `def _normalize_numeric_fragment(value: Any) -> str:`
  - `def _expected_factor_id(*, factor_type: str, params: dict[str, Any]) -> str | None:`
  - `def _major_version(value: str) -> int:`
  - `def _allowed_outputs_for_factor(`
  - `def _to_indicator_params(`
  - `def _is_valid_param_type(param_type: str, value: Any) -> bool:`
  - `def _validate_factor_indicator_contract(`
  - `def _extract_factor_ref(ref: str) -> tuple[str, str | None]:`
  - `def _validate_ref(`
  - `def _collect_operand_refs(`
  - `def _collect_condition_refs(`
  - `def _validate_stop_specs(`
  - `def validate_strategy_semantics(`
- `src/engine/strategy/parser.py`: Build typed model objects from validated strategy DSL payloads.
  - `def build_parsed_strategy(payload: dict[str, Any]) -> ParsedStrategyDsl:`
- `src/engine/strategy/pipeline.py`: End-to-end DSL validation/parsing pipeline.
  - `def load_strategy_payload(source: str | Path | dict[str, Any]) -> dict[str, Any]:`
  - `def validate_strategy_payload(`
  - `def parse_strategy_payload(`
- `src/engine/strategy/storage.py`: Strategy DSL persistence helpers backed by PostgreSQL.
  - `class StrategyMetadataReceipt:`
  - `class StrategyPersistenceResult:`
  - `class StrategyStorageNotFoundError(LookupError):`
  - `def _payload_hash(payload: dict[str, Any]) -> str:`
  - `def _as_utc(value: datetime) -> datetime:`
  - `def _build_receipt(strategy: Strategy) -> StrategyMetadataReceipt:`
  - `def _derive_strategy_columns(payload: dict[str, Any]) -> dict[str, Any]:`
  - `async def validate_strategy_payload_or_raise(`
  - `async def get_session_user_id(`
  - `async def get_strategy_or_raise(`
  - `async def upsert_strategy_dsl(`
  - `async def validate_stored_strategy(`
- `src/engine/strategy/assets/DSL_SPEC.md`: Quantitative Strategy DSL â€” Design Specification v1.0.0
- `src/engine/strategy/assets/strategy_dsl_schema.json`: JSON asset (schema/example).
- `src/engine/strategy/assets/example_strategy.json`: JSON asset (schema/example).
- `src/engine/strategy/assets/SKILL.md`: ---

## Backtest Engine

- `src/engine/backtest/__init__.py`: Event-driven backtest engine.
- `src/engine/backtest/types.py`: Typed models for event-driven backtests.
  - `class BacktestEventType(StrEnum):`
  - `class PositionSide(StrEnum):`
  - `class BacktestConfig:`
  - `class BacktestEvent:`
  - `class BacktestTrade:`
  - `class EquityPoint:`
  - `class BacktestSummary:`
  - `class BacktestResult:`
  - `def utc_now() -> datetime:`
- `src/engine/backtest/condition.py`: Condition evaluation for event-driven strategy execution.
  - `def evaluate_condition_at(`
  - `def _evaluate_cmp(`
  - `def _evaluate_cross(`
  - `def _resolve_operand(`
  - `def _resolve_ref_value(`
  - `def _is_nan(value: float) -> bool:`
  - `def _is_truthy(value: float) -> bool:`
- `src/engine/backtest/factors.py`: Factor runtime for strategy DSL backtests.
  - `def prepare_backtest_frame(`
  - `def _ensure_price_columns(frame: pd.DataFrame) -> pd.DataFrame:`
  - `def _to_indicator_params(`
  - `def _attach_factor_result(`
  - `def _resolve_output_names(`
  - `def _normalize_tokens(values: Iterable[str]) -> dict[str, str]:`
  - `def _map_macd_columns(columns: list[str]) -> dict[str, str]:`
  - `def _map_bbands_columns(columns: list[str]) -> dict[str, str]:`
  - `def _map_stoch_columns(columns: list[str]) -> dict[str, str]:`
- `src/engine/backtest/engine.py`: Event-driven backtest engine for strategy DSL.
  - `class _OpenPosition:`
  - `class EventDrivenBacktestEngine:`
  - `def __init__(`
  - `def run(self) -> BacktestResult:`
  - `def _emit(`
  - `def _infer_warmup_bars(self) -> int:`
  - `def _maybe_open_position(self, bar_index: int) -> None:`
  - `def _check_exit(self, bar_index: int) -> tuple[str, float] | None:`
  - `def _close_position(`
  - `def _record_equity(self, bar_index: int) -> None:`
  - `def _resolve_quantity(self, *, side_payload: dict[str, Any], entry_price: float) -> float:`
  - `def _max_affordable_qty(self, entry_price: float) -> float:`
  - `def _equity_value(self, bar_index: int) -> float:`
  - `def _resolve_position_stops(`
  - `def _distance_from_stop_spec(`
  - `def _build_summary(self) -> BacktestSummary:`
  - `def _max_drawdown_pct(self) -> float:`
  - `def _equity_returns(self) -> list[float]:`
  - `def _side_payload(self, side: PositionSide) -> dict[str, Any] | None:`
  - `def _timestamp_at(self, bar_index: int) -> datetime:`
  - `def _apply_entry_slippage(self, price: float, side: PositionSide) -> float:`
  - `def _apply_exit_slippage(self, price: float, side: PositionSide) -> float:`
- `src/engine/backtest/service.py`: Backtest job orchestration and persistence service.
  - `class BacktestJobReceipt:`
  - `class BacktestJobView:`
  - `class BacktestJobNotFoundError(LookupError):`
  - `class BacktestStrategyNotFoundError(LookupError):`
  - `async def create_backtest_job(`
  - `async def schedule_backtest_job(job_id: UUID) -> None:`
  - `async def _run_job_in_background(job_id: UUID) -> None:`
  - `async def execute_backtest_job(`
  - `async def get_backtest_job_view(`
  - `def _serialize_backtest_result(`
  - `def _resolve_timerange(`
  - `def _parse_dt(value: str) -> datetime:`
  - `def _pick_symbol(symbols: tuple[str, ...]) -> str:`
  - `def _to_view(job: BacktestJob) -> BacktestJobView:`
  - `def _to_external_status(internal_status: str) -> str:`
  - `def _to_utc(value: datetime) -> datetime:`
- `src/engine/performance/quantstats_wrapper.py`: QuantStats wrapper that returns stable, serializable metrics.
  - `def build_quantstats_performance(`
  - `def _build_returns_series(`
  - `def _safe_metric(getter: Callable[[], Any]) -> float | None:`
  - `def _safe_conditional_var(returns: pd.Series) -> float | None:`
  - `def _to_serializable_float(value: Any) -> float | None:`
  - `def _series_to_records(series: pd.Series) -> list[dict[str, Any]]:`
- `src/models/backtest.py`: Backtest job model.
  - `class BacktestJob(Base):`
- `src/models/strategy.py`: Strategy model definitions.
  - `class Strategy(Base):`

## MCP & Agent Integration

- `src/mcp/server.py`: Unified modular MCP server entrypoint.
  - `def create_mcp_server(`
  - `def _build_parser() -> argparse.ArgumentParser:`
  - `def main() -> int:`
- `src/mcp/strategy/tools.py`: Strategy MCP tools: DSL validation, persistence, and indicator catalog/detail lookup.
  - `def _payload(`
  - `def _parse_payload(raw: str) -> dict[str, Any]:`
  - `def _parse_uuid(value: str, field_name: str) -> UUID:`
  - `def _validation_errors_to_dict(errors: tuple[Any, ...]) -> list[dict[str, Any]]:`
  - `def _read_indicator_skill(indicator: str) -> dict[str, Any] | None:`
  - `def _normalize_indicator_inputs(`
  - `def _indicator_metadata_snapshot(indicator: str) -> dict[str, Any] | None:`
  - `def _visible_catalog_categories() -> list[IndicatorCategory]:`
  - `async def _new_db_session():`
  - `def register_strategy_tools(mcp: FastMCP) -> None:`
  - `def get_indicator_detail(`
  - `def get_indicator_catalog(category: str = \"\") -> str:`
  - `def strategy_validate_dsl(dsl_json: str) -> str:`
  - `async def strategy_upsert_dsl(`
- `src/mcp/backtest/tools.py`: Backtest MCP tools: create job + unified job query.
  - `def _payload(`
  - `def _parse_uuid(value: str, field_name: str) -> UUID:`
  - `async def _new_db_session():`
  - `def _view_payload(view: Any) -> dict[str, Any]:`
  - `def register_backtest_tools(mcp: FastMCP) -> None:`
  - `async def backtest_create_job(`
  - `async def backtest_get_job(job_id: str) -> str:`
- `src/mcp/strategy/skills/indicators/atr.md`: atr
- `src/mcp/strategy/skills/indicators/bbands.md`: bbands
- `src/mcp/strategy/skills/indicators/ema.md`: ema
- `src/mcp/strategy/skills/indicators/macd.md`: macd
- `src/mcp/strategy/skills/indicators/rsi.md`: rsi
- `src/mcp/strategy/skills/indicators/stoch.md`: stoch
- `src/agents/handlers/strategy_handler.py`: Strategy phase handler.
  - `class StrategyHandler:`
  - `def phase_name(self) -> str:`
  - `def required_fields(self) -> list[str]:`
  - `def valid_values(self) -> dict[str, set[str]]:`
  - `def build_prompt(`
  - `async def post_process(`
  - `def filter_genui(`
  - `def init_artifacts(self) -> dict[str, Any]:`
  - `def build_phase_entry_guidance(self, ctx: PhaseContext) -> str | None:`
  - `def _compute_missing(self, profile: dict[str, Any]) -> list[str]:`
  - `def _validate_patch(self, patch: dict[str, Any]) -> dict[str, str]:`
  - `def _has_value(value: Any) -> bool:`
  - `def _build_strategy_tools() -> list[dict[str, Any]]:`
- `src/agents/handlers/stress_test_handler.py`: Stress-test phase handler.
  - `class StressTestHandler:`
  - `def phase_name(self) -> str:`
  - `def required_fields(self) -> list[str]:`
  - `def valid_values(self) -> dict[str, set[str]]:`
  - `def build_prompt(`
  - `async def post_process(`
  - `def filter_genui(`
  - `def init_artifacts(self) -> dict[str, Any]:`
  - `def build_phase_entry_guidance(self, ctx: PhaseContext) -> str | None:`
  - `def _compute_missing(self, profile: dict[str, Any]) -> list[str]:`
  - `def _validate_patch(self, patch: dict[str, Any]) -> dict[str, str]:`
  - `def _has_value(value: Any) -> bool:`
  - `def _build_backtest_tools() -> list[dict[str, Any]]:`
- `src/agents/skills/strategy_skills.py`: Strategy phase prompt builders and contracts.
  - `def _load_md(path: Path) -> str:`
  - `def _render_template(template: str, values: dict[str, str]) -> str:`
  - `def _language_display(code: str) -> str:`
  - `def _load_optional_stage_addendum(stage: str | None) -> str:`
  - `def build_strategy_static_instructions(`
  - `def build_strategy_dynamic_state(`
- `src/agents/skills/stress_test_skills.py`: Stress-test phase prompt builders and contracts.
  - `def _load_md(path: Path) -> str:`
  - `def _render_template(template: str, values: dict[str, str]) -> str:`
  - `def _language_display(code: str) -> str:`
  - `def build_stress_test_static_instructions(*, language: str = "en") -> str:`
  - `def build_stress_test_dynamic_state(`
- `src/agents/skills/strategy/skills.md`: ---
- `src/agents/skills/stress_test/skills.md`: ---

## Tests

- `tests/test_engine/test_strategy_dsl_pipeline.py`: from __future__ import annotations
  - `def example_payload() -> dict[str, Any]:`
  - `def _replace_value(obj: Any, old: str, new: str) -> Any:`
  - `def _codes(result) -> set[str]:`
  - `def test_example_strategy_passes_schema_and_semantic_validation(example_payload: dict[str, Any]) -> None:`
  - `def test_schema_error_for_missing_required_field(example_payload: dict[str, Any]) -> None:`
  - `def test_schema_error_for_additional_property(example_payload: dict[str, Any]) -> None:`
  - `def test_schema_error_for_type_mismatch(example_payload: dict[str, Any]) -> None:`
  - `def test_schema_error_for_missing_trade_side(example_payload: dict[str, Any]) -> None:`
  - `def test_schema_error_for_invalid_not_structure(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_unknown_factor_ref(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_unsupported_factor_type(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_invalid_factor_param_value(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_unsupported_factor_param(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_invalid_output_name(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_multi_output_ref_without_dot_notation(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_known_multi_output_ref_without_dot_even_with_single_alias(`
  - `def test_semantic_error_for_factor_id_mismatch(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_temporal_condition(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_invalid_atr_ref(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_future_look_offset(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_error_for_unsupported_dsl_major_version(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_direct_check_for_factor_id_format_error(example_payload: dict[str, Any]) -> None:`
  - `def test_semantic_direct_check_for_bracket_rr_conflict(example_payload: dict[str, Any]) -> None:`
  - `def test_load_strategy_payload_from_path_round_trip(tmp_path: Path, example_payload: dict[str, Any]) -> None:`
- `tests/test_engine/test_strategy_storage.py`: from __future__ import annotations
  - `async def _create_user_and_session(`
  - `async def test_upsert_strategy_create_and_update_with_version_increment(`
  - `async def test_upsert_strategy_rejects_cross_user_update(db_session: AsyncSession) -> None:`
  - `async def test_upsert_strategy_rejects_invalid_payload(db_session: AsyncSession) -> None:`
  - `async def test_upsert_strategy_requires_valid_session(db_session: AsyncSession) -> None:`
  - `async def test_upsert_strategy_requires_existing_strategy_id(db_session: AsyncSession) -> None:`
  - `async def test_validate_stored_strategy_round_trip(db_session: AsyncSession) -> None:`
- `tests/test_engine/test_backtest_engine.py`: from __future__ import annotations
  - `def _ohlcv_from_close(close: list[float]) -> pd.DataFrame:`
  - `def _signal_strategy_payload() -> dict[str, Any]:`
  - `def _stop_priority_payload() -> dict[str, Any]:`
  - `def _macd_payload() -> dict[str, Any]:`
  - `def _zero_price_dual_side_payload() -> dict[str, Any]:`
  - `def _single_side_payload(`
  - `def test_event_driven_engine_opens_and_closes_on_signal() -> None:`
  - `def test_stop_loss_has_priority_over_signal_exit() -> None:`
  - `def test_multi_output_factor_refs_macd_are_resolved() -> None:`
  - `def test_engine_skips_entries_when_price_is_non_positive() -> None:`
  - `def test_take_profit_triggered_when_target_is_hit() -> None:`
  - `def test_stop_is_prioritized_when_stop_and_take_hit_in_same_bar() -> None:`
  - `def test_bracket_rr_derives_take_from_stop() -> None:`
  - `def test_bracket_rr_derives_stop_from_take() -> None:`
  - `def test_end_of_data_auto_closes_open_position() -> None:`
  - `def test_slippage_and_commission_are_applied_to_trade_pnl() -> None:`
  - `def test_short_position_is_liquidated_and_drawdown_capped_at_100_pct() -> None:`
- `tests/test_engine/test_backtest_service.py`: from __future__ import annotations
  - `async def _create_strategy(db_session: AsyncSession, *, email: str):`
  - `def _sample_frame() -> pd.DataFrame:`
  - `async def test_backtest_job_lifecycle_done(db_session: AsyncSession, monkeypatch: pytest.MonkeyPatch) -> None:`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
  - `async def test_backtest_job_lifecycle_failed(db_session: AsyncSession, monkeypatch: pytest.MonkeyPatch) -> None:`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
  - `async def test_backtest_job_view_not_found(db_session: AsyncSession) -> None:`
  - `async def test_create_backtest_job_rejects_invalid_config_values(db_session: AsyncSession) -> None:`
  - `async def test_backtest_job_fails_when_stored_strategy_payload_is_invalid(`
  - `async def test_backtest_job_uses_explicit_date_range_over_metadata(`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
  - `async def test_backtest_job_uses_explicit_start_with_metadata_end(`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
  - `async def test_backtest_job_uses_metadata_start_with_explicit_end(`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
- `tests/test_engine/test_performance_quantstats.py`: from __future__ import annotations
  - `def _sample_timestamps(length: int) -> list[datetime]:`
  - `def _minimal_payload() -> dict:`
  - `def _sample_ohlcv() -> dict:`
  - `def test_quantstats_wrapper_returns_stable_serializable_shape() -> None:`
  - `def test_backtest_engine_result_contains_performance_block() -> None:`
- `tests/test_mcp/test_strategy_tools.py`: from __future__ import annotations
  - `class _SessionContext:`
  - `def __init__(self, session: AsyncSession) -> None:`
  - `async def __aenter__(self) -> AsyncSession:`
  - `async def __aexit__(self, exc_type, exc, tb) -> bool:  # noqa: ANN001`
  - `def _extract_payload(call_result: object) -> dict[str, Any]:`
  - `async def _create_session(db_session: AsyncSession, email: str) -> AgentSession:`
  - `async def test_indicator_catalog_and_detail_tools() -> None:`
  - `async def test_strategy_validate_dsl_tool_covers_pass_and_fail() -> None:`
  - `async def test_strategy_upsert_tool_supports_create_and_update(`
  - `async def _fake_new_db_session() -> _SessionContext:`
  - `async def test_strategy_upsert_tool_reports_input_errors(db_session: AsyncSession, monkeypatch: pytest.MonkeyPatch) -> None:`
  - `async def _fake_new_db_session() -> _SessionContext:`
- `tests/test_mcp/test_backtest_tools.py`: from __future__ import annotations
  - `class _SessionContext:`
  - `def __init__(self, session: AsyncSession) -> None:`
  - `async def __aenter__(self) -> AsyncSession:`
  - `async def __aexit__(self, exc_type, exc, tb) -> bool:  # noqa: ANN001`
  - `def _extract_payload(call_result: object) -> dict[str, Any]:`
  - `async def _create_strategy(db_session: AsyncSession, email: str):`
  - `def _sample_frame() -> pd.DataFrame:`
  - `async def test_backtest_tools_create_run_and_fetch_result(`
  - `async def _fake_new_db_session() -> _SessionContext:`
  - `async def _fake_schedule(job_id):  # noqa: ANN001`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`
  - `async def test_backtest_tools_pending_and_input_errors(`
  - `async def _fake_new_db_session() -> _SessionContext:`
  - `async def _fake_schedule(job_id):  # noqa: ANN001`
  - `async def test_backtest_tools_failed_run_returns_error_payload(`
  - `async def _fake_new_db_session() -> _SessionContext:`
  - `async def _fake_schedule(job_id):  # noqa: ANN001`
  - `def _fake_load(`
  - `def _fake_metadata(self, market: str, symbol: str) -> dict[str, object]:  # noqa: ANN001`

## Exposed MCP Tools

- strategy: `strategy_validate_dsl`, `strategy_upsert_dsl`, `get_indicator_detail`, `get_indicator_catalog`
- backtest: `backtest_create_job`, `backtest_get_job`

## Latest Test Evidence

- `pytest tests/test_engine/test_strategy_dsl_pipeline.py tests/test_engine/test_strategy_storage.py tests/test_engine/test_backtest_engine.py tests/test_engine/test_backtest_service.py tests/test_mcp/test_strategy_tools.py tests/test_mcp/test_backtest_tools.py tests/test_agents/test_phase_handlers.py tests/test_agents/test_pre_strategy_dynamic_rules.py tests/test_agents/test_genui_registry.py -q` -> `67 passed`
