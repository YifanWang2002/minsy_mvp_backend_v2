# Minsy backend environment template
# Copy this file to .env and fill secrets/addresses for your machine.
#
# Recommended now:
# 1) copy env/.env.common.example -> env/.env.common
# 2) copy env/.env.dev.example or env/.env.prod.example -> env/.env.<profile>
# 3) run scripts/render_env.sh --profile <profile>
# 4) start with MINSY_ENV_FILE=.env.<profile> (or scripts/dev_up.sh)

# -----------------------------------------------------------------------------
# Runtime mode (single switch for dev/prod behavior)
# -----------------------------------------------------------------------------
# APP_ENV controls:
# 1) MCP domain URL selection (*_DEV vs *_PROD for each category)
# 2) CORS strategy (dev/test: allow all origins; prod: use CORS_ORIGINS)
APP_ENV=dev

# -----------------------------------------------------------------------------
# App and server
# -----------------------------------------------------------------------------
APP_NAME=Minsy
DEBUG=true
API_V1_PREFIX=/api/v1
# Public API base URL used for external callback URL derivation.
# Example: https://api.minsyai.com
API_PUBLIC_BASE_URL=
HOST=0.0.0.0
PORT=8000
LOG_LEVEL=INFO
CHAT_DEBUG_TRACE_ENABLED=false
CHAT_DEBUG_TRACE_MODE=compact

# -----------------------------------------------------------------------------
# Observability (Sentry)
# -----------------------------------------------------------------------------
# Keep SENTRY_DSN empty to disable runtime reporting.
SENTRY_DSN=https://2d85e73109159fc0c6ab492acbfecea9@o4510922349543424.ingest.us.sentry.io/4510922367631360
SENTRY_ENV=dev  
SENTRY_RELEASE=0.1.0
SENTRY_TRACES_SAMPLE_RATE=0.0
SENTRY_PROFILES_SAMPLE_RATE=0.0
# Capture non-2xx FastAPI responses as Sentry message events.
SENTRY_HTTP_STATUS_CAPTURE_ENABLED=true
# Capture range [min, max], typically 4xx/5xx.
SENTRY_HTTP_STATUS_MIN_CODE=400
SENTRY_HTTP_STATUS_MAX_CODE=599
# JSON list.
SENTRY_HTTP_STATUS_EXCLUDE_PATHS=["/api/v1/health","/api/v1/status"]

# -----------------------------------------------------------------------------
# OpenAI + MCP
# -----------------------------------------------------------------------------
OPENAI_API_KEY=<your_openai_api_key>
OPENAI_RESPONSE_MODEL=gpt-5.2
OPENAI_COST_TRACKING_ENABLED=true
# JSON object: model -> token-price map (USD per token).
# (OpenAI official pricing, queried on 2026-02-21; update when pricing changes.)
# Includes gpt-5 / gpt-5.1 / gpt-5.2 full family + common aliases.
OPENAI_PRICING_JSON={"default":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5-chat-latest":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5-codex":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5-mini":{"input_per_token":0.00000025,"output_per_token":0.000002},"gpt-5-nano":{"input_per_token":0.00000005,"output_per_token":0.0000004},"gpt-5-pro":{"input_per_token":0.000015,"output_per_token":0.00012},"gpt-5.1":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5.1-chat-latest":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5.1-codex":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5.1-codex-max":{"input_per_token":0.00000125,"output_per_token":0.00001},"gpt-5.2":{"input_per_token":0.00000175,"output_per_token":0.000014},"gpt-5.2-chat-latest":{"input_per_token":0.00000175,"output_per_token":0.000014},"gpt-5.2-codex":{"input_per_token":0.00000175,"output_per_token":0.000014},"gpt-5.2-pro":{"input_per_token":0.000021,"output_per_token":0.000168}}
# MCP server URLs are managed per domain/category.
MCP_SERVER_URL_STRATEGY_DEV=https://dev.minsyai.com/strategy/mcp
MCP_SERVER_URL_STRATEGY_PROD=https://mcp.minsyai.com/strategy/mcp
MCP_SERVER_URL_BACKTEST_DEV=https://dev.minsyai.com/backtest/mcp
MCP_SERVER_URL_BACKTEST_PROD=https://mcp.minsyai.com/backtest/mcp
MCP_SERVER_URL_MARKET_DATA_DEV=https://dev.minsyai.com/market/mcp
MCP_SERVER_URL_MARKET_DATA_PROD=https://mcp.minsyai.com/market/mcp
MCP_SERVER_URL_STRESS_DEV=https://dev.minsyai.com/stress/mcp
MCP_SERVER_URL_STRESS_PROD=https://mcp.minsyai.com/stress/mcp
MCP_SERVER_URL_TRADING_DEV=https://dev.minsyai.com/trading/mcp
MCP_SERVER_URL_TRADING_PROD=https://mcp.minsyai.com/trading/mcp
# Optional: local reverse-proxy upstreams for `python -m src.mcp.dev_proxy`.
MCP_PROXY_UPSTREAM_STRATEGY=http://127.0.0.1:8111
MCP_PROXY_UPSTREAM_BACKTEST=http://127.0.0.1:8112
MCP_PROXY_UPSTREAM_MARKET=http://127.0.0.1:8113
MCP_PROXY_UPSTREAM_STRESS=http://127.0.0.1:8114
MCP_PROXY_UPSTREAM_TRADING=http://127.0.0.1:8115
MCP_CONTEXT_SECRET=
MCP_CONTEXT_TTL_SECONDS=300
TELEGRAM_ENABLED=true
TELEGRAM_BOT_TOKEN=
TELEGRAM_BOT_USERNAME=
TELEGRAM_WEBHOOK_SECRET_TOKEN=
# Optional explicit full webhook URL. If empty and auto-sync is enabled,
# backend derives it from API_PUBLIC_BASE_URL + API_V1_PREFIX + /social/webhooks/telegram.
TELEGRAM_WEBHOOK_URL=
# When enabled, backend startup calls Telegram setWebhook if current URL differs.
TELEGRAM_WEBHOOK_AUTO_SYNC_ENABLED=false
TELEGRAM_CONNECT_TTL_SECONDS=600
NOTIFICATIONS_ENABLED=true
NOTIFICATIONS_LOOP_INTERVAL_SECONDS=5
NOTIFICATIONS_DISPATCH_BATCH_SIZE=10
NOTIFICATIONS_DELIVERY_TIMEOUT_SECONDS=6
NOTIFICATIONS_DISPATCH_MAX_RUNTIME_SECONDS=8
NOTIFICATIONS_DISPATCH_LOCK_TTL_SECONDS=30
NOTIFICATIONS_RETRY_MAX_ATTEMPTS=3
NOTIFICATIONS_RETRY_BACKOFF_SECONDS=5
TRADING_APPROVAL_ENABLED=true
TRADING_APPROVAL_EXPIRE_SCAN_INTERVAL_SECONDS=10
TELEGRAM_APPROVAL_CALLBACK_SECRET=

# -----------------------------------------------------------------------------
# Alpaca (paper-trading integration)
# -----------------------------------------------------------------------------
# Paper-trading runtime toggles:
PAPER_TRADING_ENABLED=true
PAPER_TRADING_ENQUEUE_ON_START=true
# Set to true to send orders to broker paper endpoints (real exchange connectivity, paper funds).
PAPER_TRADING_EXECUTE_ORDERS=true
PAPER_TRADING_LOOP_INTERVAL_SECONDS=1.0
PAPER_TRADING_STARTING_RETRY_SECONDS=10
PAPER_TRADING_BROKER_ACCOUNT_SYNC_INTERVAL_SECONDS=20
PAPER_TRADING_RUNTIME_TASK_EXPIRES_SECONDS=120
PAPER_TRADING_QUEUE_BACKLOG_SOFT_LIMIT=2000
PAPER_TRADING_SCHEDULER_MAX_ENQUEUES_PER_TICK=500
PAPER_TRADING_MAX_RETRIES=3
PAPER_TRADING_KILL_SWITCH_GLOBAL=false
PAPER_TRADING_KILL_SWITCH_USERS=
PAPER_TRADING_KILL_SWITCH_DEPLOYMENTS=
PAPER_TRADING_BROKER_RETRY_MAX_ATTEMPTS=3
PAPER_TRADING_BROKER_RETRY_BACKOFF_SECONDS=0.2
PAPER_TRADING_CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
PAPER_TRADING_CIRCUIT_BREAKER_RECOVERY_SECONDS=30
PAPER_TRADING_RUNTIME_HEALTH_STALE_SECONDS=120
PAPER_TRADING_DEPLOYMENT_LOCK_TTL_SECONDS=20
BACKTEST_MAX_BARS=3000000
BACKTEST_STALE_JOB_CLEANUP_ENABLED=true
BACKTEST_STALE_JOB_CLEANUP_INTERVAL_MINUTES=10
BACKTEST_RUNNING_STALE_MINUTES=30
BACKTEST_RESULT_MAX_TRADES=20000
BACKTEST_RESULT_MAX_EQUITY_POINTS=5000
BACKTEST_RESULT_MAX_RETURNS=5000
BACKTEST_RESULT_MAX_EVENTS=2000
# Optional dedicated secret for broker credential encryption at rest:
TRADING_CREDENTIALS_SECRET=

# Required for upcoming Alpaca execution/data modules:
ALPACA_API_KEY=
ALPACA_API_SECRET=
# Keep paper endpoint by default. Switch to live endpoint only when live trading
# is explicitly enabled in runtime logic:
ALPACA_TRADING_BASE_URL=https://paper-api.alpaca.markets
ALPACA_PAPER_TRADING_BASE_URL=https://paper-api.alpaca.markets
ALPACA_LIVE_TRADING_BASE_URL=https://api.alpaca.markets
ALPACA_ACCOUNT_PROBE_TIMEOUT_SECONDS=8
ALPACA_MARKET_DATA_BASE_URL=https://data.alpaca.markets
ALPACA_MARKET_DATA_STREAM_URL=wss://stream.data.alpaca.markets/v2
ALPACA_REQUEST_RATE_LIMIT_PER_MINUTE=200
ALPACA_STREAM_RECONNECT_BASE_SECONDS=1.0
ALPACA_STREAM_MAX_RETRIES=10
# Data feed defaults for MVP:
ALPACA_STOCKS_FEED=iex
ALPACA_CRYPTO_FEED=us
# Market-data runtime/cache controls:
MARKET_DATA_BACKFILL_LIMIT=500
MARKET_DATA_REFRESH_ACTIVE_SUBSCRIPTIONS_INTERVAL_SECONDS=15
MARKET_DATA_AGGREGATE_TIMEFRAMES=5m,15m,1h,1d
MARKET_DATA_AGGREGATE_TIMEZONE=UTC
MARKET_DATA_RING_CAPACITY_1M=45000
MARKET_DATA_RING_CAPACITY_AGG=10000
MARKET_DATA_FACTOR_CACHE_MAX_ENTRIES=200000
MARKET_DATA_CHECKPOINT_TTL_SECONDS=86400

# -----------------------------------------------------------------------------
# PostgreSQL
# -----------------------------------------------------------------------------
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=123456
POSTGRES_DB=minsy_pgsql
POSTGRES_POOL_SIZE=10
POSTGRES_MAX_OVERFLOW=20
SQLALCHEMY_ECHO=false

# -----------------------------------------------------------------------------
# Redis + Celery
# -----------------------------------------------------------------------------
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_MAX_CONNECTIONS=50
CELERY_BROKER_URL=
CELERY_RESULT_BACKEND=
CELERY_TASK_DEFAULT_QUEUE=backtest
CELERY_TASK_TIME_LIMIT_SECONDS=1800
CELERY_TASK_SOFT_TIME_LIMIT_SECONDS=1740
CELERY_WORKER_MAX_MEMORY_PER_CHILD=524288
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_TASK_ACKS_LATE=true
CELERY_TASK_ALWAYS_EAGER=false
CELERY_TIMEZONE=UTC
FLOWER_ENABLED=false
FLOWER_HOST=127.0.0.1
FLOWER_PORT=5555
FLOWER_USER=
FLOWER_PASSWORD=

# -----------------------------------------------------------------------------
# Maintenance jobs
# -----------------------------------------------------------------------------
POSTGRES_BACKUP_ENABLED=true
POSTGRES_BACKUP_DIR=backups/postgres
POSTGRES_BACKUP_RETENTION_COUNT=14
POSTGRES_BACKUP_HOUR_UTC=3
POSTGRES_BACKUP_MINUTE_UTC=0
POSTGRES_PG_DUMP_BIN=pg_dump
USER_EMAIL_CSV_EXPORT_ENABLED=true
USER_EMAIL_CSV_PATH=exports/user_emails.csv
USER_EMAIL_CSV_EXPORT_INTERVAL_MINUTES=60

# -----------------------------------------------------------------------------
# CORS (used only when APP_ENV=prod)
# -----------------------------------------------------------------------------
CORS_ORIGINS=["https://app.minsyai.com","https://dev.minsyai.com"]
# Optional regex (also applied in prod) for dynamic localhost ports.
CORS_ORIGIN_REGEX=^http://(localhost|127\.0\.0\.1)(:\d+)?$

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
SECRET_KEY=<jwt_secret>
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440
REFRESH_TOKEN_EXPIRE_DAYS=7
AUTH_RATE_LIMIT=30
AUTH_RATE_WINDOW=60
